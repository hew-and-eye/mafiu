import{getStateObject}from"./getStateObject.js";import{getParsedTemplate}from"./getParsedTemplate.js";function registerMafiuComponent({name:t,template:e,data:i={},hooks:s={},handlers:a={}}){getImplicitVariables(e).forEach(t=>{i[t]=null!=(t=i[t])?t:""}),i._stateVars=Object.keys(i),e=getParsedTemplate(e,i);var r=class extends HTMLElement{constructor(){super()}static get observedAttributes(){return i._stateVars.map(t=>t.toLowerCase())}connectedCallback(){this.innerHTML=e,this.addListeners(),this.dependencyTree=this.parseDependencies(),Object.assign(s,this.getRenderHooks({data:i,hooks:s})),this.state=getStateObject(this,{data:i,hooks:s}),this.handlers=a,this.state._stateVars.forEach(t=>{this.hasAttribute(t)&&this.state&&(this.state[t]=this.getAttribute(t))})}attributeChangedCallback(e,t,s){var a;this.state&&(a=i._stateVars.find(t=>t.toLowerCase()===e),this.state[a]=s)}parseDependencies(){const r={};return this.querySelectorAll("[has-mdeps]").forEach(a=>{const t=a.getAttributeNames().filter(t=>t.startsWith("mdep"));t.forEach(t=>{let[,e,s]=t.split("-");(s=i._stateVars.find(t=>t.toLowerCase()===s))&&(r[s]||(r[s]=[]),r[s].push({el:a,attribute:e,innerText:!e}))})}),r}getRenderHooks({data:t,hooks:s}){return Object.keys(t).reduce((t,e)=>(t[e]=s[e]||[],t[e].push(s=>{var t;this.dependencyTree&&null!=(t=this.dependencyTree[e])&&t.forEach(({el:t,attribute:e})=>{e?t.setAttribute(e,s):t.innerText=s})}),t),{})}addListeners(){this.querySelectorAll("[mbind]").forEach(t=>{const[e,s]=t.getAttribute("mbind").split(":");console.log("Going to add a listener",e,s),t.addEventListener(s,t=>{this.state[e]=t.detail||t.target.value})}),this.querySelectorAll("[mhandle]").forEach(t=>{const[e,s]=t.getAttribute("mhandle").split(":");t.addEventListener(s,t=>{this.handlers[e].call(this,s),t.stopImmediatePropagation()})})}};window.customElements.define(t,r)}function getImplicitVariables(t){const e=[];return null!=(t=t.match(/{{([^}}]*)}}/gm))&&t.forEach(t=>{t=t.replace("{{","").replace("}}","");e.push(t)}),e}export{registerMafiuComponent};